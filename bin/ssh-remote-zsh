#!/bin/zsh

# echos out with color
#
# Called:
#   `color_echo red "My Error"`
#   `color_echo yellow "My Warning"`
#   `color_echo green "My Success"`
function color_echo () {
    case $1 in
     red)     
          color=31
          ;;
     green)
          color=32
          ;;
     yellow)
          color=33
          ;;
     *)  
          color=$1
          ;;
    esac

    # remove $1
    shift

    echo -e "\033[1;${color}m$@\033[0m"
}

FLAG=""
NO_FORWARD=false

if [ $# -eq 0 ] ; then
    echo "Missing Hostname"
    exit 1
fi

# parse commandline
while [ $# -gt 0 ]
do
      arg="$1"
      case "$arg" in
         --no-forward) NO_FORWARD=true; ;;
         -*) FLAG="$FLAG $1"; ;; # add flag
         *) break;; # not option, its some argument
       esac
       shift
done

# check for out of date dotfiles on remote server
if ssh -A $1 "[[ ! -f $DOTFILES/VERSION ]] || cat $DOTFILES/VERSION | grep -v -q -P '^$DOTFILES_VERSION'" ; then
    color_echo yellow "Transferring files..."
    tar c -C${HOME} --gzip --exclude-vcs --exclude '.plugin_list' --exclude '.vim/*' --exclude '.viminfo' --exclude '*.swp' .dotfiles-harrison | ssh $1 'tar mxz -C${HOME} --no-same-owner --overwrite --dereference'
    color_echo green "Updated to $DOTFILES_VERSION"
fi

# maybe check if zsh is installed and if not install it? Or return an error?

if [ $NO_FORWARD = true ] ; then
    ssh $FLAG -t $1 "ZDOTDIR=$DOTFILES $(which zsh)"
else
    ssh $FLAG -A -t $1 "ZDOTDIR=$DOTFILES $(which zsh)"
fi
